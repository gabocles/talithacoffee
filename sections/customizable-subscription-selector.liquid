{%- liquid
  assign selected_collection = collections[section.settings.collection]
  assign products = selected_collection.products
-%}

{%- comment -%} DEBUG: Product information {%- endcomment -%}
{% comment %}
  <div style="background: #f0f0f0; padding: 20px; margin: 20px 0; border: 2px solid #ccc; font-family: monospace; font-size: 12px;">
    <h3>üêõ DEBUG: Product Information</h3>

    <p><strong>Selected Collection:</strong> {{ section.settings.collection }}</p>
    <p><strong>Collection Name:</strong> {{ selected_collection.title }}</p>
    <p><strong>Total Products:</strong> {{ products.size }}</p>

    {%- for product in products -%}
      <div style="border: 1px solid #999; margin: 10px 0; padding: 10px; background: white;">
        <h4>Product {{ forloop.index }}: {{ product.title }}</h4>
        <p><strong>ID:</strong> {{ product.id }}</p>
        <p><strong>Handle:</strong> {{ product.handle }}</p>
        <p><strong>Price:</strong> {{ product.price | money }}</p>
        <p><strong>Available:</strong> {{ product.available }}</p>
        <p><strong>Type:</strong> {{ product.type }}</p>
        <p><strong>Vendor:</strong> {{ product.vendor }}</p>

        <h5>üéØ Variants ({{ product.variants.size }}):</h5>
        {%- for variant in product.variants -%}
          <div style="margin-left: 20px; padding: 5px; border-left: 2px solid #ddd;">
            <p>
              <strong>Variant {{ forloop.index }}:</strong> {{ variant.title }}
            </p>
            <p><strong>ID:</strong> {{ variant.id }}</p>
            <p><strong>SKU:</strong> {{ variant.sku }}</p>
            <p><strong>Price:</strong> {{ variant.price | money }}</p>
            <p><strong>Available:</strong> {{ variant.available }}</p>
            <p><strong>Inventory:</strong> {{ variant.inventory_quantity }}</p>

            {%- if variant.options.size > 0 -%}
              <p><strong>Options:</strong></p>
              {%- for option in variant.options -%}
                <span style="background: #e0e0e0; padding: 2px 5px; margin: 2px; display: inline-block;">
                  {{- option -}}
                </span>
              {%- endfor -%}
            {%- endif -%}
          </div>
        {%- endfor -%}

        <h5>‚öôÔ∏è Product Options ({{ product.options.size }}):</h5>
        {%- for option in product.options -%}
          <div style="margin-left: 20px; padding: 5px; border-left: 2px solid #ddd;">
            <p>
              <strong>{{ option.name }}:</strong>
            </p>
            <p><strong>Position:</strong> {{ option.position }}</p>
            <p><strong>Values:</strong></p>
            {%- for value in option.values -%}
              <span style="background: #e0f0ff; padding: 2px 5px; margin: 2px; display: inline-block;">{{ value }}</span>
            {%- endfor -%}
          </div>
        {%- endfor -%}

        <h5>üìÖ Selling Plan Groups ({{ product.selling_plan_groups.size }}):</h5>
        {%- for group in product.selling_plan_groups -%}
          <div style="margin-left: 20px; padding: 5px; border-left: 2px solid #ddd;">
            <script>
              console.log('Grupo:', {{ group | json }});
            </script>
            <p>
              <strong>Grupo {{ forloop.index }}:</strong> {{ group.name }}
            </p>
            <p><strong>ID:</strong> {{ group.id }}</p>
            <p><strong>App ID:</strong> {{ group.app_id }}</p>

            <h6>üìã Selling Plans ({{ group.selling_plans.size }}):</h6>
            {%- for plan in group.selling_plans -%}
              <div style="margin-left: 20px; padding: 3px; background: #f9f9f9;">
                <p>
                  <strong>Plan {{ forloop.index }}:</strong> {{ plan.name }}
                </p>
                <p><strong>ID:</strong> {{ plan.id }}</p>
                <p><strong>Description:</strong> {{ plan.description }}</p>

                {%- if plan.options.size > 0 -%}
                  <p><strong>Plan Options:</strong></p>
                  {%- for option in plan.options -%}
                    <div style="margin-left: 10px;">
                      <p>
                        <strong>{{ option.name }}:</strong> {{ option.value }}
                      </p>
                    </div>
                  {%- endfor -%}
                {%- endif -%}

                {%- if plan.price_adjustments.size > 0 -%}
                  <p><strong>Price Adjustments:</strong></p>
                  {%- for adjustment in plan.price_adjustments -%}
                    <div style="margin-left: 10px;">
                      <p>
                        <p><strong>Order:</strong> {{ adjustment.order_count }} - <strong>Value:</strong>
                        {{ adjustment.value -}}
                        {{- adjustment.value_type }}
                      </p>
                    </div>
                  {%- endfor -%}
                {%- endif -%}
              </div>
            {%- endfor -%}
          </div>
        {%- endfor -%}

        <h5>üè∑Ô∏è Tags:</h5>
        <p>{{ product.tags | join: ', ' }}</p>

        <h5>üñºÔ∏è Images ({{ product.images.size }}):</h5>
        {%- for image in product.images limit: 3 -%}
          <img src="{{ image | img_url: '100x' }}" alt="{{ product.title }}" style="margin: 5px; border: 1px solid #ccc;">
        {%- endfor -%}
      </div>
    {%- endfor -%}

    <h3>üé® Icon Metaobjects</h3>
    {%- if shop.metaobjects.image_icon_urls -%}
      {%- for icon_group in shop.metaobjects.image_icon_urls.values -%}
        <div style="border: 1px solid #999; margin: 10px 0; padding: 10px; background: white;">
          <h4>Icon Group {{ forloop.index }}</h4>
          <p><strong>ID:</strong> {{ icon_group.id }}</p>
          <p><strong>Handle:</strong> {{ icon_group.handle }}</p>

          {%- if icon_group.options -%}
            <h5>Icon Options:</h5>
            {%- for option in icon_group.options.value -%}
              <div style="margin-left: 20px; padding: 5px; border-left: 2px solid #ddd;">
                <p><strong>Name:</strong> {{ option.name }}</p>
                {%- if option.image_url -%}
                  <p><strong>Image URL:</strong> {{ option.image_url.value }}</p>
                  <img
                    src="{{ option.image_url.value | image_url }}"
                    alt="{{ option.name }}"
                    style="width: 30px; height: 30px; margin: 5px;"
                  >
                {%- endif -%}
              </div>
            {%- endfor -%}
          {%- endif -%}
        </div>
      {%- endfor -%}
    {%- else -%}
      <p>‚ùå No icon metaobjects found</p>
    {%- endif -%}
  </div>
{% endcomment %}

<div class="sideContainer">
  <div class="subscriptionMainDiv">
    <div class="subscribeSection" id="subscribeSection">
      {%- if section.settings.show_title -%}
        <div class="subscription-header">
          <h1>{{ section.settings.title | default: 'Customize Your Subscription' }}</h1>
          {%- if section.settings.subtitle != blank -%}
            <p>{{ section.settings.subtitle }}</p>
          {%- endif -%}
        </div>
      {%- endif -%}

      <div class="subscriptionSteps" id="subscriptionSteps">
        {%- comment -%} STEP 1: Product Selection {%- endcomment -%}
        {%- if section.settings.enable_product_selection -%}
          <div class="subscriptionOption step active" id="productSelectStep" data-step="1">
            <h2>
              <span class="step-indicator">1</span>
              {{ section.settings.product_step_title | default: 'Select your product:' }}
            </h2>
            <div class="subscriptionRow product-grid">
              {%- for product in products -%}
                <div class="subscriptionCol product-col" data-product="{{ product | json | escape }}">
                  <input
                    type="radio"
                    id="product-{{ product.id }}"
                    name="selectedProduct"
                    value="{{ product.id }}"
                    class="selection-steps-radio"
                    data-product-data="{{ product | json | escape }}"
                  >
                  <label for="product-{{ product.id }}" class="subscriptionCard card_product">
                    <div class="itemDiv itemCardRelative">
                      <div class="itemCard selectProductImage">
                        <div class="itemIcon">
                          <img
                            src="{{ product.images[0] | img_url: '400x' }}"
                            alt="{{ product.title }}"
                            loading="lazy"
                            width="120"
                            height="120"
                          >
                        </div>
                      </div>
                      <div class="itemDetail">
                        <h4>{{ product.title }}</h4>
                        {%- if section.settings.show_product_price -%}
                          <p class="price">{{ product.price | money }}</p>
                        {%- endif -%}
                        {%- if product.description != blank -%}
                          <p class="description">{{ product.description | strip_html | truncate: 80 }}</p>
                        {%- endif -%}
                      </div>
                    </div>
                  </label>
                </div>
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}

        {%- comment -%} STEP 2: Gift Options (MOVED HERE - DISABLED BY DEFAULT) {%- endcomment -%}
        {%- if section.settings.enable_gift_options -%}
          <div class="subscriptionOption step" id="giftStep" data-step="2">
            <h2>
              <span class="step-indicator">2</span>
              {{ section.settings.gift_step_title | default: 'Gift options:' }}
            </h2>
            <div class="subscriptionRow">
              <div class="subscriptionCol">
                <input type="radio" id="gift-no" name="isGift" value="false" class="selection-steps-radio">
                <label for="gift-no" class="subscriptionCard">
                  <div class="itemDiv">
                    <div class="itemIcon">
                      {%- assign icon_found = false -%}
                      {%- for icon_group in shop.metaobjects.image_icon_urls.values -%}
                        {%- for option in icon_group.options.value -%}
                          {%- assign option_name_normalized = option.name | downcase | replace: ' ', '_' -%}
                          {%- assign search_term_normalized = 'user' | downcase | replace: ' ', '_' -%}
                          {%- if option_name_normalized contains search_term_normalized -%}
                            <img
                              src="{{ option.image_url.value | image_url }}"
                              alt="{{ option.name }}"
                              width="40"
                              height="40"
                            >
                            {%- assign icon_found = true -%}
                            {%- break -%}
                          {%- endif -%}
                        {%- endfor -%}
                        {%- if icon_found -%}{%- break -%}{%- endif -%}
                      {%- endfor -%}
                      {%- unless icon_found -%}
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                      {%- endunless -%}
                    </div>
                    <div class="itemDetail">
                      <h4>For me</h4>
                    </div>
                  </div>
                </label>
              </div>
              <div class="subscriptionCol">
                <input type="radio" id="gift-yes" name="isGift" value="true" class="selection-steps-radio">
                <label for="gift-yes" class="subscriptionCard">
                  <div class="itemDiv">
                    <div class="itemIcon">
                      {%- assign icon_found = false -%}
                      {%- for icon_group in shop.metaobjects.image_icon_urls.values -%}
                        {%- for option in icon_group.options.value -%}
                          {%- assign option_name_normalized = option.name | downcase | replace: ' ', '_' -%}
                          {%- assign search_term_normalized = 'gift' | downcase | replace: ' ', '_' -%}
                          {%- if option_name_normalized contains search_term_normalized -%}
                            <img
                              src="{{ option.image_url.value | image_url }}"
                              alt="{{ option.name }}"
                              width="40"
                              height="40"
                            >
                            {%- assign icon_found = true -%}
                            {%- break -%}
                          {%- endif -%}
                        {%- endfor -%}
                        {%- if icon_found -%}{%- break -%}{%- endif -%}
                      {%- endfor -%}
                      {%- unless icon_found -%}
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                      {%- endunless -%}
                    </div>
                    <div class="itemDetail">
                      <h4>As a gift</h4>
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        {%- endif -%}

        {%- comment -%} STEP 3: Size Selection (RENUMBERED) {%- endcomment -%}
        {%- if section.settings.enable_size_selection -%}
          <div class="subscriptionOption step" id="sizeStep" data-step="3">
            <h2>
              <span class="step-indicator">3</span>
              Select Size:
            </h2>
            <div class="subscriptionRow" id="sizeContainer">
              {%- comment -%} Will be populated dynamically {%- endcomment -%}
            </div>
          </div>
        {%- endif -%}

        {%- comment -%} STEP 4: Grind Selection (RENUMBERED) {%- endcomment -%}
        {%- if section.settings.enable_grind_selection -%}
          <div class="subscriptionOption step" id="grindStep" data-step="4">
            <h2>
              <span class="step-indicator">4</span>
              Select Grind:
            </h2>
            <div class="subscriptionRow" id="grindContainer">
              {%- comment -%} Will be populated dynamically {%- endcomment -%}
            </div>
          </div>
        {%- endif -%}

        {%- comment -%} STEP 5: Quantity Selection (RENUMBERED) {%- endcomment -%}
        {%- if section.settings.enable_quantity_selection -%}
          <div class="subscriptionOption step" id="quantityStep" data-step="5">
            <h2>
              <span class="step-indicator">5</span>
              {{ section.settings.quantity_step_title | default: 'How much do you want?' }}
            </h2>
            <div class="subscriptionRow" id="quantityContainer">
              {%- for i in (1..section.settings.max_quantity) -%}
                <div class="subscriptionCol size">
                  <input
                    type="radio"
                    id="quantity-{{ i }}"
                    name="selectedQuantity"
                    value="{{ i }}"
                    class="selection-steps-radio"
                  >
                  <label for="quantity-{{ i }}" class="subscriptionCard card_two">
                    <div class="itemDiv">
                      <div class="itemIcon">
                        {%- assign icon_url = '' -%}
                        {%- for singleStep in shop.metaobjects.image_icon_urls.values -%}
                          {%- for singleStepSingleOption in singleStep.options.value -%}
                            {%- assign option_name_normalized = singleStepSingleOption.name | downcase -%}
                            {%- case i -%}
                              {%- when 1 -%}
                                {%- if option_name_normalized == 'one bag' or option_name_normalized == '12oz' -%}
                                  {%- assign icon_url = singleStepSingleOption.image_url.value -%}
                                  {%- break -%}
                                {%- endif -%}
                              {%- when 2 -%}
                                {%- if option_name_normalized == 'two bags'
                                  or option_name_normalized == 'two 12oz bag'
                                -%}
                                  {%- assign icon_url = singleStepSingleOption.image_url.value -%}
                                  {%- break -%}
                                {%- endif -%}
                              {%- when 3 -%}
                                {%- if option_name_normalized == 'three bags'
                                  or option_name_normalized == 'three 12oz bag'
                                -%}
                                  {%- assign icon_url = singleStepSingleOption.image_url.value -%}
                                  {%- break -%}
                                {%- endif -%}
                            {%- endcase -%}
                          {%- endfor -%}
                          {%- if icon_url != blank -%}{%- break -%}{%- endif -%}
                        {%- endfor -%}
                        {%- if icon_url != blank -%}
                          <img src="{{ icon_url | image_url }}" alt="{{ i }} bag" width="40" height="40">
                        {%- else -%}
                          <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                            <text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold">{{ i }}</text>
                          </svg>
                        {%- endif -%}
                      </div>
                      <div class="itemDetail">
                        <h4>{{ i }} bag{{ i | pluralize: '', 's' }}</h4>
                      </div>
                    </div>
                  </label>
                </div>
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}

        {%- comment -%} STEP 6: Coffee Type Selection (MOVED BEFORE FREQUENCY) {%- endcomment -%}
        {%- if section.settings.enable_coffee_type_selection -%}
          <div class="subscriptionOption step" id="coffeeTypeStep" data-step="6">
            <h2>
              <span class="step-indicator">6</span>
              {{ section.settings.coffee_type_step_title | default: 'Select Coffee Type:' }}
            </h2>
            <div class="subscriptionRow" id="coffeeTypeContainer">
              {%- comment -%} Will be populated dynamically {%- endcomment -%}
            </div>
          </div>
        {%- endif -%}

        {%- comment -%} STEP 7: Frequency Selection (LAST STEP) {%- endcomment -%}
        {%- if section.settings.enable_frequency_selection -%}
          <div class="subscriptionOption step" id="frequencyStep" data-step="7">
            <h2>
              <span class="step-indicator">7</span>
              {{ section.settings.frequency_step_title | default: 'How often?' }}
            </h2>
            <div class="subscriptionRow" id="frequencyContainer">
              {%- comment -%} Frequencies will be populated dynamically by JavaScript {%- endcomment -%}
            </div>
          </div>
        {%- endif -%}

        {%- comment -%} Add to Cart Button {%- endcomment -%}
        {%- if section.settings.show_add_to_cart -%}
          <p
            class="shipping-notice"
            style="text-align: center; margin: 20px 0 10px; font-size: 0.9rem; opacity: 0.8; color: #d4af37;"
          >
            (Shipping is not included during the 2 months on us.)
          </p>
          <button type="button" class="add-subscription-btn" id="addSubscriptionBtn">
            {{ section.settings.add_to_cart_text | default: 'Add to Cart' }}
          </button>
        {%- endif -%}
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="error-modal-overlay">
  <div class="error-modal">
    <div class="error-modal-header">
      <div class="error-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
          <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <h3>Error</h3>
    </div>
    <div class="error-modal-body">
      <p id="errorMessage">An error occurred</p>
    </div>
    <div class="error-modal-footer">
      <button type="button" class="error-modal-close" onclick="closeErrorModal()">OK</button>
    </div>
  </div>
</div>

<style>
  .sideContainer {
    max-width: calc(100% - 60px);
    margin: 0 auto;
  }

  .subscriptionMainDiv {
    display: flex;
    flex-wrap: wrap;
  }

  .subscribeSection {
    width: 100%;
    background: #1b3c34;
    min-height: 615px;
    padding: 40px 70px;
    color: white;
  }

  .subscription-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .subscription-header h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: white;
  }

  .subscription-header p {
    font-size: 1.1rem;
    opacity: 0.9;
  }

  .subscriptionSteps {
    display: flex;
    flex-direction: column;
    gap: 30px;
  }

  .subscriptionOption {
    margin-bottom: 30px;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  /* Progressive step display - REAL step by step */
  .step {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s ease;
  }

  .step.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }

  .step.completed {
    display: block;
    opacity: 0.8;
  }

  /* Step indicators */
  .step-indicator {
    display: inline-block;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #ccc;
    color: white;
    text-align: center;
    line-height: 30px;
    margin-right: 10px;
    font-weight: bold;
    font-size: 14px;
  }

  .step.active .step-indicator {
    background: #d4af37;
    animation: pulse 2s infinite;
  }

  .step.completed .step-indicator {
    background: #28a745;
    cursor: pointer;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(212, 175, 55, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(212, 175, 55, 0);
    }
  }

  .subscriptionOption h2 {
    font-size: 1.5rem;
    margin-bottom: 20px;
    color: white;
  }

  .subscriptionRow {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: flex-start;
  }

  /* 3-column grid for products */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }

  .product-col {
    width: 100%;
  }

  .subscriptionCol {
    flex: 0 0 auto;
    min-width: 200px;
  }

  .subscriptionCard {
    display: block;
    background: white;
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    color: #333;
    height: 100%;
  }

  .subscriptionCard:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .selection-steps-radio:checked + .subscriptionCard {
    border-color: #d4af37;
    background: #f9f7f0;
  }

  .selection-steps-radio {
    display: none;
  }

  .itemDiv {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    height: 100%;
  }

  .itemIcon {
    margin-bottom: 15px;
  }

  .itemIcon img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
  }

  .itemIcon svg {
    width: 40px;
    height: 40px;
    color: #1b3c34;
  }

  .itemDetail {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .itemDetail h4 {
    margin: 0 0 8px 0;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .itemDetail h5 {
    margin: 4px 0;
    font-size: 0.85rem;
    opacity: 0.7;
    font-weight: normal;
  }

  .itemDetail p {
    margin: 4px 0;
    font-size: 0.9rem;
    opacity: 0.8;
  }

  .itemDetail .price {
    font-weight: 600;
    color: #d4af37;
  }

  .itemDetail .description {
    font-size: 0.8rem;
    line-height: 1.3;
  }

  .annual-option {
    margin-top: 15px;
  }

  .add-subscription-btn {
    display: none;
    background: #d4af37;
    color: white;
    border: none;
    padding: 15px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 300px;
    margin: 30px auto 0;
  }

  .add-subscription-btn.visible {
    display: block;
    animation: slideUp 0.5s ease;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .add-subscription-btn:hover {
    background: #b8941f;
  }

  @media (max-width: 1024px) {
    .product-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .subscribeSection {
      padding: 20px;
    }

    .product-grid {
      grid-template-columns: 1fr;
    }

    .subscriptionRow {
      justify-content: center;
    }

    .subscriptionCol {
      min-width: 150px;
      flex: 1 1 calc(50% - 10px);
    }

    .subscription-header h1 {
      font-size: 2rem;
    }
  }

  @media (max-width: 480px) {
    .subscriptionCol {
      flex: 1 1 100%;
    }
  }

  /* Error Modal Styles */
  .error-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .error-modal-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  .error-modal {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
    transform: scale(0.7) translateY(-50px);
    transition: all 0.3s ease;
    border: 2px solid #FFA400;
  }

  .error-modal-overlay.show .error-modal {
    transform: scale(1) translateY(0);
  }

  .error-modal-header {
    background: linear-gradient(135deg, #1A3C34, #336458);
    color: #fff;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .error-icon {
    width: 24px;
    height: 24px;
    color: #FFA400;
    flex-shrink: 0;
  }

  .error-modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    font-family: 'Rajdhani', sans-serif;
  }

  .error-modal-body {
    padding: 24px;
    color: #1A3C34;
  }

  .error-modal-body p {
    margin: 0;
    font-size: 16px;
    line-height: 1.5;
    font-family: 'Carlito', sans-serif;
  }

  .error-modal-footer {
    padding: 16px 24px 24px;
    text-align: right;
  }

  .error-modal-close {
    background: linear-gradient(135deg, #1A3C34, #336458);
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Rajdhani', sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .error-modal-close:hover {
    background: linear-gradient(135deg, #336458, #1A3C34);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26, 60, 52, 0.3);
  }

  .error-modal-close:active {
    transform: translateY(0);
  }

  /* Animation keyframes */
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: scale(0.7) translateY(-50px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  @keyframes modalSlideOut {
    from {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    to {
      opacity: 0;
      transform: scale(0.7) translateY(-50px);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const productRadios = document.querySelectorAll('input[name="selectedProduct"]');
    const frequencyContainer = document.getElementById('frequencyContainer');
    const addToCartBtn = document.getElementById('addSubscriptionBtn');
    
  // Global variables
    let currentStepIndex = 0;
    let selectedProductData = null;
    let steps = [];
  let stepHistory = []; // For backward navigation

  // Icon data from metaobjects
    const iconData = {
      {%- for singleStep in shop.metaobjects.image_icon_urls.values -%}
        {%- for singleStepSingleOption in singleStep.options.value -%}
          '{{ singleStepSingleOption.name | downcase | replace: ' ', '_' }}': '{{ singleStepSingleOption.image_url.value | image_url }}',
        {%- endfor -%}
      {%- endfor -%}
    };

  // Improved initialization
    function initializeSteps() {
      steps = document.querySelectorAll('.step');
      
  // Hide all steps except the first
      steps.forEach((step, index) => {
        if (index === 0) {
          step.classList.add('active');
          step.style.display = 'block';
        } else {
          step.style.display = 'none';
        }
      });
      
  // Add backward navigation
      addBackwardNavigation();
      
      if (addToCartBtn) {
        addToCartBtn.style.display = 'none';
      }
    }

  // Improved function for backward navigation
    function addBackwardNavigation() {
      steps.forEach((step, index) => {
        const stepIndicator = step.querySelector('.step-indicator');
        if (stepIndicator) {
          // Allow click on all completed steps and the current one
          if (index <= currentStepIndex) {
            stepIndicator.style.cursor = 'pointer';
            
            // Clean previous event listeners by cloning the element
            const newIndicator = stepIndicator.cloneNode(true);
            stepIndicator.parentNode.replaceChild(newIndicator, stepIndicator);
            
            // Add new event listener
            newIndicator.addEventListener('click', () => goToStep(index));
          }
        }
      });
    }

  // Corrected function to go to a specific step
    function goToStep(targetIndex) {
  // Allow going to any previous step or the current one
      if (targetIndex > currentStepIndex) return;
      
  // If it's the same step, do nothing
      if (targetIndex === currentStepIndex) return;
      
  // Reset and HIDE steps after the target
      for (let i = targetIndex + 1; i < steps.length; i++) {
        const step = steps[i];
        step.classList.remove('active', 'completed');
  step.style.display = 'none'; // Completely HIDE
        
  // Clear selections in subsequent steps
        const radios = step.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => radio.checked = false);
      }
      
  // Update current index
      currentStepIndex = targetIndex;
      
  // COMPLETELY RESET all steps and set correct states
      for (let i = 0; i <= targetIndex; i++) {
        const step = steps[i];
  step.style.display = 'block'; // Ensure it's visible
        
  // Remove ALL state classes first
        step.classList.remove('active', 'completed');
        
        if (i < targetIndex) {
          // Steps before the target: mark as completed
          step.classList.add('completed');
        } else if (i === targetIndex) {
          // Target step: activate and remove any completed state
          step.classList.add('active');
        }
      }
      
  // Scroll to the target step
      steps[targetIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      
  // Update navigation
      addBackwardNavigation();
      
  // Check and show add to cart button
      checkAndShowAddToCartButton();
    }

  // Corrected function for isCurrentStepCompleted
    function isCurrentStepCompleted() {
      const currentStep = steps[currentStepIndex];
      if (!currentStep) return false;
      
      const stepId = currentStep.id;
      
      switch(stepId) {
        case 'productSelectStep':
          return document.querySelector('input[name="selectedProduct"]:checked') !== null;
        
        case 'giftStep':

          const giftStep = document.getElementById('giftStep');
          if (!giftStep) return true; // Skip this step if it doesn't exist
          return document.querySelector('input[name="isGift"]:checked') !== null;
        
        case 'sizeStep':
          return document.querySelector('input[name="selectedSize"]:checked') !== null;
        
        case 'grindStep':
          return document.querySelector('input[name="selectedGrind"]:checked') !== null;
        
        case 'quantityStep':
          return document.querySelector('input[name="selectedQuantity"]:checked') !== null;
        
        case 'frequencyStep':
          return document.querySelector('input[name="selectedFrequency"]:checked') !== null;
        
        case 'coffeeTypeStep':
          return document.querySelector('input[name="selectedCoffeeType"]:checked') !== null;
        
        default:
          return false;
      }
    }

  // Function to check and show Add to Cart button
    function checkAndShowAddToCartButton() {
      console.log('Checking Add to Cart button visibility...');
      console.log('Current step index:', currentStepIndex);
      console.log('Total steps:', steps.length);
      console.log('Is last step:', currentStepIndex === steps.length - 1);
      console.log('Is current step completed:', isCurrentStepCompleted());
      
      if (currentStepIndex === steps.length - 1 && isCurrentStepCompleted()) {
        if (addToCartBtn) {
          addToCartBtn.style.display = 'block';
          addToCartBtn.classList.add('visible');
          console.log('‚úÖ Add to Cart button is now visible');
        }
      } else {
        if (addToCartBtn) {
          addToCartBtn.style.display = 'none';
          addToCartBtn.classList.remove('visible');
          console.log('‚ùå Add to Cart button is hidden');
        }
      }
    }

    // Improved function to advance to the next step
    function advanceToNextStep() {
      if (currentStepIndex < steps.length - 1) {
  // Mark current step as completed
        steps[currentStepIndex].classList.add('completed');
        steps[currentStepIndex].classList.remove('active');
        
  // Move to the next step
        currentStepIndex++;
        
  // SHOW and activate the next step
        steps[currentStepIndex].style.display = 'block';
        steps[currentStepIndex].classList.add('active');
        
  // Scroll to the new step
        steps[currentStepIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        
  // Populate content if necessary
        populateStepContent(steps[currentStepIndex]);
        
  // Update navigation
        addBackwardNavigation();
      }
      
  // Check and show add to cart button
      checkAndShowAddToCartButton();
    }

  // Corrected function to populate step content
    function populateStepContent(step) {
      const stepId = step.id;
      
      switch(stepId) {
        case 'sizeStep':
          if (selectedProductData) {
            updateSizeOptions(selectedProductData);
          }
          break;
          
        case 'grindStep':
          if (selectedProductData) {
            updateGrindOptions(selectedProductData);
          }
          break;
          
        case 'frequencyStep':
          if (selectedProductData) {
            updateFrequencyOptions(selectedProductData);
          }
          break;
          
        case 'coffeeTypeStep':
          if (selectedProductData) {
            updateCoffeeTypeOptions(selectedProductData);
          }
          break;
      }
    }

  // Simplified function - DO NOT create dynamic steps, only populate existing ones
    function updateProductOptions(product) {
      if (!product.variants || product.variants.length === 0) return;
      
      // Get size options (first product option)
      const sizeOptions = new Set();
      product.variants.forEach(variant => {
        if (variant.available && variant.options && variant.options[0]) {
          sizeOptions.add(variant.options[0]);
        }
      });
      
      // Get grind options (second product option)
      const grindOptions = new Set();
      product.variants.forEach(variant => {
        if (variant.available && variant.options && variant.options[1]) {
          grindOptions.add(variant.options[1]);
        }
      });
      
  // DO NOT create dynamic steps - use only static ones
  // The steps sizeStep and grindStep already exist in the HTML
      
  // Update steps array
      steps = document.querySelectorAll('.step');
    }

  // Corrected function for updateSizeOptions
    function updateSizeOptions(product) {
      const sizeContainer = document.getElementById('sizeContainer');
      if (!sizeContainer) return;
      
      sizeContainer.innerHTML = '';
      
  // Get size options (first product option)
      const sizeOptions = new Set();
      
      product.variants.forEach(variant => {
        if (variant.available && variant.options && variant.options[0]) {
          sizeOptions.add(variant.options[0]);
        }
      });
      
      const sizes = Array.from(sizeOptions);
      
      sizes.forEach((size, index) => {
        const col = document.createElement('div');
        col.className = 'subscriptionCol';
        
        const iconUrl = findIconUrl(size.toLowerCase());
        let iconHtml = '';
        
        if (iconUrl) {
          iconHtml = `<img src="${iconUrl}" alt="${size}" width="40" height="40">`;
        } else {
          iconHtml = getDefaultIcon('Size', size);
        }
        
        col.innerHTML = `
          <input 
            type="radio" 
            id="size-${index}" 
            name="selectedSize" 
            value="${size}" 
            class="selection-steps-radio"
          >
          <label for="size-${index}" class="subscriptionCard">
            <div class="itemDiv">
              <div class="itemIcon">
                ${iconHtml}
              </div>
              <div class="itemDetail">
                <h4>${size}</h4>
                <h5>Size</h5>
              </div>
            </div>
          </label>
        `;
        
        sizeContainer.appendChild(col);
      });
      
  // Add event listeners
      addEventListenersToStep(document.getElementById('sizeStep'));
    }

  // Corrected function for updateGrindOptions
    function updateGrindOptions(product) {
      const grindContainer = document.getElementById('grindContainer');
      if (!grindContainer) return;
      
      grindContainer.innerHTML = '';
      
  // Get grind options (second product option)
      const grindOptions = new Set();
      
      product.variants.forEach(variant => {
        if (variant.available && variant.options && variant.options[1]) {
          grindOptions.add(variant.options[1]);
        }
      });
      
      const grinds = Array.from(grindOptions);
      
      grinds.forEach((grind, index) => {
        const col = document.createElement('div');
        col.className = 'subscriptionCol';
        
        const iconUrl = findIconUrl(grind.toLowerCase());
        let iconHtml = '';
        
        if (iconUrl) {
          iconHtml = `<img src="${iconUrl}" alt="${grind}" width="40" height="40">`;
        } else {
          iconHtml = getDefaultIcon('Grind', grind);
        }
        
        col.innerHTML = `
          <input 
            type="radio" 
            id="grind-${index}" 
            name="selectedGrind" 
            value="${grind}" 
            class="selection-steps-radio"
          >
          <label for="grind-${index}" class="subscriptionCard">
            <div class="itemDiv">
              <div class="itemIcon">
                ${iconHtml}
              </div>
              <div class="itemDetail">
                <h4>${grind}</h4>
                <h5>Grind</h5>
              </div>
            </div>
          </label>
        `;
        
        grindContainer.appendChild(col);
      });
      
  // Add event listeners
      addEventListenersToStep(document.getElementById('grindStep'));
    }

    // Function to filter grind options based on selected size
    function updateGrindOptionsForSize(product, selectedSize) {
      const grindContainer = document.getElementById('grindContainer');
      if (!grindContainer || !selectedSize) return;
      
      grindContainer.innerHTML = '';
      
      // Filter variants that match the selected size
      const availableGrinds = new Set();
      
      product.variants.forEach(variant => {
        if (variant.available && variant.options && variant.options[0] === selectedSize) {
          if (variant.options[1]) {
            availableGrinds.add(variant.options[1]);
          }
        }
      });
      
      const grinds = Array.from(availableGrinds);
      
      grinds.forEach((grind, index) => {
        const col = document.createElement('div');
        col.className = 'subscriptionCol';
        
        const iconUrl = findIconUrl(grind.toLowerCase());
        let iconHtml = '';
        
        if (iconUrl) {
          iconHtml = `<img src="${iconUrl}" alt="${grind}" width="40" height="40">`;
        } else {
          iconHtml = getDefaultIcon('Grind', grind);
        }
        
        col.innerHTML = `
          <input 
            type="radio" 
            id="grind-${index}" 
            name="selectedGrind" 
            value="${grind}" 
            class="selection-steps-radio"
          >
          <label for="grind-${index}" class="subscriptionCard">
            <div class="itemDiv">
              <div class="itemIcon">
                ${iconHtml}
              </div>
              <div class="itemDetail">
                <h4>${grind}</h4>
                <h5>Grind</h5>
              </div>
            </div>
          </label>
        `;
        
        grindContainer.appendChild(col);
      });
      
      // Add event listeners
      addEventListenersToStep(document.getElementById('grindStep'));
    }

    function updateFrequencyOptions(product) {
      if (!frequencyContainer) return;
      
      frequencyContainer.innerHTML = '';
      
      const showAnnualOption = {{ section.settings.show_annual_option | json }};
      
      if (showAnnualOption) {
        // Show only annual subscription options
        if (product.selling_plan_groups && product.selling_plan_groups.length > 0) {
          const annualGroup = product.selling_plan_groups.find(group => 
            group.name && group.name.toLowerCase().includes('annual')
          );
          
          if (annualGroup && annualGroup.selling_plans) {
            // Show only the first annual plan (all are the same)
            const plan = annualGroup.selling_plans[0];
            const col = document.createElement('div');
            col.className = 'subscriptionCol size';
            
            let iconHtml = findIconUrl('12 months') ? 
              `<img src="${findIconUrl('12 months')}" alt="Annual Subscription" width="40" height="40">` :
              getFrequencyIcon('annual');
            
            col.innerHTML = `
              <input 
                type="radio" 
                id="frequency-annual" 
                name="selectedFrequency" 
                value="annual" 
                class="selection-steps-radio"
              >
              <label for="frequency-annual" class="subscriptionCard card_three">
                <div class="itemDiv">
                  <div class="itemIcon">
                    ${iconHtml}
                  </div>
                  <div class="itemDetail">
                    <h4>Annual Subscription</h4>
                    <h5>Every Month</h5>
                  </div>
                </div>
              </label>
            `;
            
            frequencyContainer.appendChild(col);
          }
        }
      } else {
        // Show only weekly frequencies (exclude annual group)
        if (product.selling_plan_groups && product.selling_plan_groups.length > 0) {
          product.selling_plan_groups.forEach((group, groupIndex) => {
            // Skip the annual group
            if (group.name && group.name.toLowerCase().includes('annual')) {
              return;
            }
            
            if (group.selling_plans && group.selling_plans.length > 0) {
              group.selling_plans.forEach((plan, planIndex) => {
                const col = document.createElement('div');
                col.className = 'subscriptionCol size';
                
                const planName = plan.name.replace('Delivery ', '');
                const weekMatch = planName.match(/(\d+)\s*week/);
                const weeks = weekMatch ? weekMatch[1] : (groupIndex + 1);
                
                // Search for specific icon for the frequency
                let iconHtml = findIconUrl(`Every ${weeks} week${weeks > 1 ? 's' : ''}`) || 
                              findIconUrl(`${weeks} week`) ||
                              getFrequencyIcon(weeks);
                
                col.innerHTML = `
                  <input 
                    type="radio" 
                    id="frequency-${plan.id}" 
                    name="selectedFrequency" 
                    value="${plan.id}" 
                    class="selection-steps-radio"
                  >
                  <label for="frequency-${plan.id}" class="subscriptionCard card_three">
                    <div class="itemDiv">
                      <div class="itemIcon">
                        ${iconHtml}
                      </div>
                      <div class="itemDetail">
                        <h4>Every ${weeks} week${weeks > 1 ? 's' : ''}</h4>
                        <h5>Subscription</h5>
                      </div>
                    </div>
                  </label>
                `;
                
                frequencyContainer.appendChild(col);
              });
            }
          });
        }
      }
      
      // Add event listeners
      addEventListenersToStep(document.getElementById('frequencyStep'));
    }

    // Function to update coffee type options
    function updateCoffeeTypeOptions(selectedProduct) {
      const coffeeTypeContainer = document.getElementById('coffeeTypeContainer');
      if (!coffeeTypeContainer || !selectedProduct) return;
      
      coffeeTypeContainer.innerHTML = '';
      
      // Get coffee type options (third product option)
      const coffeeTypeOptions = new Set();
      
      selectedProduct.variants.forEach(variant => {
        if (variant.available && variant.options && variant.options[2]) {
          coffeeTypeOptions.add(variant.options[2]);
        }
      });
      
      const coffeeTypes = Array.from(coffeeTypeOptions);
      
      coffeeTypes.forEach((coffeeType, index) => {
        const col = document.createElement('div');
        col.className = 'subscriptionCol size';
        
        const iconUrl = findIconUrl(coffeeType.toLowerCase());
        let iconHtml = '';
        
        if (iconUrl) {
          iconHtml = `<img src="${iconUrl}" alt="${coffeeType}" width="40" height="40">`;
        } else {
          iconHtml = getDefaultIcon('CoffeeType', coffeeType);
        }
        
        col.innerHTML = `
          <input 
            type="radio" 
            id="coffee-type-${index}" 
            name="selectedCoffeeType" 
            value="${coffeeType}" 
            class="selection-steps-radio"
          >
          <label for="coffee-type-${index}" class="subscriptionCard card_four">
            <div class="itemDiv">
              <div class="itemIcon">
                ${iconHtml}
              </div>
              <div class="itemDetail type">
                <h4>${coffeeType}</h4>
              </div>
            </div>
          </label>
        `;
        
        coffeeTypeContainer.appendChild(col);
      });
      
      // Add event listeners
      addEventListenersToStep(document.getElementById('coffeeTypeStep'));
    }

  // Function to get the coffee type icon using icon-finder
    function getCoffeeTypeIcon(coffeeType) {
      const normalizedType = coffeeType.toLowerCase();
      
  // First try to find in metaobjects
      const iconUrl = findIconUrl(normalizedType);
      if (iconUrl) {
        return `<img src="${iconUrl}" alt="${coffeeType}" width="40" height="40">`;
      }
      
  // If not found, use icon-finder as fallback
      return `{% render 'icon-finder', icon: 'box' %}`;
    }

    // Helper functions
    function findIconUrl(searchTerm) {
      const normalizedTerm = searchTerm.toLowerCase().replace(/\s+/g, '_');
      
  // Direct search
      if (iconData[normalizedTerm]) {
        return iconData[normalizedTerm];
      }
      
  // Specific mappings to improve search
      const iconMappings = {
  // Sizes
        'one_bag': 'one_bag',
        'two_bags': 'two_bags', 
        'three_bags': 'three_bags',
        '12oz': '12oz',
        'two_12oz_bag': 'two_12oz_bag',
        'three_12oz_bag': 'three_12oz_bag',
        '2lbs': '2lbs',
        '2lb': '2lb',
        '2lb': '2LB',
        '5lb': '5lb',
        '5lb': '5LB',
        
  // Frequencies
        'every_1_week': 'every_1_week',
        'every_2_weeks': 'every_2_weeks', 
        'every_3_weeks': 'every_3_weeks',
        'every_4_weeks': 'every_4_weeks',
        '1_week': '1_week',
        '2_week': '2_week',
        '3_week': '3_week', 
        '4_week': '4_week',
        '3_months': '3_months',
        '6_months': '6_months',
        '12_months': '12_months',
        
  // Grind types
        'whole_bean': 'whole_bean',
        'ground_coffee': 'ground_coffee',
        'whole_bean_gift': 'whole_bean_gift',
        'ground_coffee_gift': 'ground_coffee_gift',
        'espresso': 'espresso',
        'aeropress': 'aeropress',
        'drip': 'drip',
        'french': 'french',
        
  // Coffee types
        'arise': 'arise',
        'virtuosa': 'virtuosa',
        'ignite': 'ignite', 
        'uganda': 'uganda',
        'shantawene': 'shantawene',
        'huehuetenango': 'huehuetenango',
        
  // Gift options
        'giftsomeone': 'giftsomeone',
        'gift_someone': 'giftsomeone'
      };
      
  // Search in specific mappings
      if (iconMappings[normalizedTerm]) {
        const mappedKey = iconMappings[normalizedTerm];
        if (iconData[mappedKey]) {
          return iconData[mappedKey];
        }
      }
      
  // Improved flexible search
      for (const [key, url] of Object.entries(iconData)) {
  // Exact search
        if (key === normalizedTerm) {
          return url;
        }
        
  // Partial search
        if (key.includes(normalizedTerm) || normalizedTerm.includes(key)) {
          return url;
        }
        
  // Keyword search
        const keyWords = key.split('_');
        const searchWords = normalizedTerm.split('_');
        
        const hasCommonWords = keyWords.some(word => 
          searchWords.some(searchWord => 
            word.includes(searchWord) || searchWord.includes(word)
          )
        );
        
        if (hasCommonWords && keyWords.length >= 2 && searchWords.length >= 2) {
          return url;
        }
      }
      
      return null;
    }

    // Function to get the default icon
    function getDefaultIcon(optionName, value) {
      const name = optionName.toLowerCase();
      const val = value.toLowerCase();
      
      if (name.includes('size') || name.includes('weight')) {
        return `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
      } else if (name.includes('grind') || name.includes('type')) {
        return `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;
      } else {
        return `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/></svg>`;
      }
    }

    function getFrequencyIcon(weeks) {
      if (weeks === 'annual' || weeks === '12_months') {
        const iconUrl = findIconUrl('12_months') || findIconUrl('12_month');
        if (iconUrl) {
          return `<img src="${iconUrl}" alt="Annual Subscription" width="40" height="40">`;
        }
        return `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>`;
      }
      
      // Try different variations for frequencies
      const variations = [
        `every_${weeks}_week${weeks > 1 ? 's' : ''}`,
        `every_${weeks}_week`,
        `${weeks}_week${weeks > 1 ? 's' : ''}`, 
        `${weeks}_week`
      ];
      
      for (const variation of variations) {
        const iconUrl = findIconUrl(variation);
        if (iconUrl) {
          return `<img src="${iconUrl}" alt="Every ${weeks} weeks" width="40" height="40">`;
        }
      }
      
      return `<svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>`;
    }

    // Function to handle frequency selection
    function handleFrequencySelection(input) {
      console.log('Frequency selected:', input.value);
      
      // Store the selected frequency globally
      window.selectedFrequency = input.value;
      
      // You can add additional logic here if needed
      // For example, updating pricing or other UI elements
    }

    // Add event listeners to step inputs
    function addEventListenersToStep(step) {
      if (!step) return;
      
      const inputs = step.querySelectorAll('input[type="radio"]');
      inputs.forEach(input => {
        input.addEventListener('change', () => {
          // Special logic for when a size is selected
          if (input.name === 'selectedSize' && selectedProductData) {
            updateGrindOptionsForSize(selectedProductData, input.value);
          }
          
          if (input.name === 'selectedFrequency') {
            handleFrequencySelection(input);
          }
          
          setTimeout(() => {
            if (isCurrentStepCompleted()) {
              advanceToNextStep();
            }
            checkAndShowAddToCartButton();
          }, 100);
        });
      });
    }
    productRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.checked) {
          selectedProductData = JSON.parse(this.getAttribute('data-product-data'));
          updateSizeOptions(selectedProductData);
          updateGrindOptions(selectedProductData);
          updateCoffeeTypeOptions(selectedProductData);
          updateFrequencyOptions(selectedProductData);
          
          setTimeout(() => {
            if (isCurrentStepCompleted()) {
              advanceToNextStep();
            }
            checkAndShowAddToCartButton();
          }, 100);
        }
      });
    });

    // Add event listeners to initial steps
    document.querySelectorAll('.step').forEach(step => {
      addEventListenersToStep(step);
    });

  // Initialize when the DOM is ready
    initializeSteps();

    // Add to cart functionality
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', async function () {
        try {
            console.log('üõí Starting Add to Cart process...');
          
            // Validate that a product has been selected
            const selectedProduct = document.querySelector('input[name="selectedProduct"]:checked');
            if (!selectedProduct) {
              showErrorModal('Please select a product');
              return;
            }

            console.log('‚úÖ Product selected:', selectedProduct.value);

            // Get user selections
            const selectedSize = document.querySelector('input[name="selectedSize"]:checked')?.value;
            const selectedGrind = document.querySelector('input[name="selectedGrind"]:checked')?.value;
            const selectedQuantity = document.querySelector('input[name="selectedQuantity"]:checked')?.value || '1';
            const selectedCoffeeType = document.querySelector('input[name="selectedCoffeeType"]:checked')?.value;
            const selectedFrequency = document.querySelector('input[name="selectedFrequency"]:checked')?.value;

            console.log('üìã User selections:', {
              size: selectedSize,
              grind: selectedGrind,
              quantity: selectedQuantity,
              coffeeType: selectedCoffeeType,
              frequency: selectedFrequency
            });

            // Validate required selections
            if (!selectedSize) {
              showErrorModal('Please select a size');
              return;
            }
            if (!selectedGrind) {
              showErrorModal('Please select a grind type');
              return;
            }
            if (!selectedFrequency) {
              showErrorModal('Please select a frequency');
              return;
            }

            // Get product data
            let productData;
            try {
              productData = JSON.parse(selectedProduct.dataset.productData);
              console.log('üì¶ Product data:', productData);
            } catch (parseError) {
              console.error('‚ùå Error parsing product data:', parseError);
              showErrorModal('Error in product data. Please reload the page.');
              return;
            }
          
            // Build options array to find the variant
            const selectedOptions = [selectedSize, selectedGrind];
            if (selectedCoffeeType) {
              selectedOptions.push(selectedCoffeeType);
            }

            console.log('üîç Searching for variant with options:', selectedOptions);
            console.log('üìä Available variants:', productData.variants);

            // Find matching variant
            const matchingVariant = findMatchingVariant(selectedOptions, productData.variants);
          
            if (!matchingVariant) {
              console.error('‚ùå No matching variant found');
              console.log('Searched options:', selectedOptions);
              console.log('Available variants:', productData.variants.map(v => ({
                id: v.id,
                options: [v.option1, v.option2, v.option3].filter(Boolean),
                available: v.available
              })));
              showErrorModal('No variant found that matches your selections. Please verify your options.');
              return;
            }

            console.log('‚úÖ Matching variant found:', matchingVariant);

            // Check availability
            if (!matchingVariant.available) {
              showErrorModal('Sorry, this variant is not available at the moment.');
              return;
            }

            // Prepare data for the cart
            const cartData = {
              id: matchingVariant.id,
              quantity: parseInt(selectedQuantity)
            };
          
            // Add selling plan if frequency is selected
            if (selectedFrequency) {
              if (selectedFrequency === 'annual') {
                // Find the selling plan for annual subscription
                const annualPlan = findAnnualSellingPlan(productData);
                if (annualPlan) {
                  cartData.selling_plan = annualPlan.id;
                  console.log('üìÖ Annual selling plan found:', annualPlan);
                } else {
                  console.warn('‚ö†Ô∏è Annual selling plan not found for this product');
                }
              } else {
                cartData.selling_plan = selectedFrequency;
              }
            }

            console.log('üõçÔ∏è Cart data:', cartData);

            addToCartBtn.disabled = true;
            addToCartBtn.textContent = 'Adding...';

            const response = await fetch(`${window.location.origin}/cart/add.js`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(cartData)
            });

            if (!response.ok) {
              const errorText = await response.text();
              console.error('‚ùå HTTP Error:', response.status, errorText);
              throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
            }

            const responseData = await response.json();
            console.log('‚úÖ Product added successfully:', responseData);
          
            if (window.theme && window.theme.cartCount) {
              window.theme.cartCount.update();
            }
          
          } catch (error) {
            console.error('‚ùå Error adding product to cart:', error);
            showErrorModal(`There was an error adding the product to cart: ${error.message}`);
          } finally {
            addToCartBtn.disabled = false;
            addToCartBtn.textContent = '{{ section.settings.add_to_cart_text | default: "Add to Cart" }}';
          }
        });
    }

    // Function to find annual selling plan
    function findAnnualSellingPlan(productData) {
      if (!productData.selling_plan_groups) {
        return null;
      }
      
      for (const group of productData.selling_plan_groups) {
        // Search for group containing 'annual', '12-month', 'yearly' in the name
        if (group.name && 
            (group.name.toLowerCase().includes('annual') || 
             group.name.toLowerCase().includes('12-month') || 
             group.name.toLowerCase().includes('yearly'))) {
          
          // Return first selling plan from annual group
          if (group.selling_plans && group.selling_plans.length > 0) {
            console.log('üéØ Annual group found:', group.name, 'Plan ID:', group.selling_plans[0].id);
            return group.selling_plans[0];
          }
        }
      }
      
      console.warn('‚ö†Ô∏è No annual selling plan group found');
      return null;
    }

    // Improved helper function to find matching variant
    function findMatchingVariant(selectedOptions, variants) {
      console.log('üîç Searching for variant with options:', selectedOptions);
      
      return variants.find(variant => {
        if (!variant.available) {
          return false;
        }
        
        const variantOptions = [variant.option1, variant.option2, variant.option3].filter(Boolean);
        console.log(`Comparing variant ${variant.id}:`, variantOptions, 'with selections:', selectedOptions);
        
        // Verify that all selected options are in the variant
        const matches = selectedOptions.every(option => variantOptions.includes(option));
        
        if (matches) {
          console.log('‚úÖ Matching variant found:', variant.id);
        }
        
        return matches;
      });
    }

    // Error Modal Functions
    window.showErrorModal = function(message) {
      const modal = document.getElementById('errorModal');
      const messageElement = document.getElementById('errorMessage');
      
      if (modal && messageElement) {
        messageElement.textContent = message;
        modal.classList.add('show');
        
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
      }
    };

    window.showSuccessModal = function(message) {
      const modal = document.getElementById('errorModal');
      const messageElement = document.getElementById('errorMessage');
      const header = modal.querySelector('.error-modal-header h3');
      const icon = modal.querySelector('.error-icon');
      const closeBtn = modal.querySelector('.error-modal-close');
      
      if (modal && messageElement) {
        messageElement.textContent = message;
        header.textContent = 'Success';
        icon.style.color = '#28a745';
        closeBtn.style.background = '#28a745';
        closeBtn.onmouseover = () => closeBtn.style.background = '#218838';
        closeBtn.onmouseout = () => closeBtn.style.background = '#28a745';
        
        // Update icon to checkmark
        icon.innerHTML = `
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
        
        modal.classList.add('show');
        
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
      }
    };

    window.closeErrorModal = function() {
      const modal = document.getElementById('errorModal');
      const header = modal.querySelector('.error-modal-header h3');
      const icon = modal.querySelector('.error-icon');
      const closeBtn = modal.querySelector('.error-modal-close');
      
      if (modal) {
        modal.classList.remove('show');
        
        // Restore body scroll
        document.body.style.overflow = '';
        
        // Reset to error state for next use
        setTimeout(() => {
          header.textContent = 'Error';
          icon.style.color = '#dc3545';
          closeBtn.style.background = '#dc3545';
          closeBtn.onmouseover = () => closeBtn.style.background = '#c82333';
          closeBtn.onmouseout = () => closeBtn.style.background = '#dc3545';
          
          // Reset icon to X
          icon.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
              <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
              <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
            </svg>
          `;
        }, 300);
      }
    };

    // Close modal when clicking outside
    document.getElementById('errorModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeErrorModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('errorModal');
        if (modal.classList.contains('show')) {
          closeErrorModal();
        }
      }
    });
  });
</script>

{% schema %}
{
  "name": "Subscription Selector",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select the collection to display products from"
    },
    {
      "type": "header",
      "content": "Section Display"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show section title",
      "default": true
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section title",
      "default": "Customize Your Subscription"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Section subtitle"
    },
    {
      "type": "header",
      "content": "Step 1: Product Selection"
    },
    {
      "type": "checkbox",
      "id": "enable_product_selection",
      "label": "Enable product selection step",
      "default": true
    },
    {
      "type": "text",
      "id": "product_step_title",
      "label": "Product step title",
      "default": "Select your product:"
    },
    {
      "type": "checkbox",
      "id": "show_product_price",
      "label": "Show product prices",
      "default": true
    },
    {
      "type": "header",
      "content": "Step 2: Product Options"
    },
    {
      "type": "checkbox",
      "id": "enable_size_selection",
      "label": "Enable size selection step",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_grind_selection",
      "label": "Enable grind selection step",
      "default": true
    },
    {
      "type": "header",
      "content": "Step 3: Quantity Selection"
    },
    {
      "type": "checkbox",
      "id": "enable_quantity_selection",
      "label": "Enable quantity selection step",
      "default": true
    },
    {
      "type": "text",
      "id": "quantity_step_title",
      "label": "Quantity step title",
      "default": "How much do you want?"
    },
    {
      "type": "range",
      "id": "max_quantity",
      "min": 1,
      "max": 10,
      "step": 1,
      "label": "Maximum quantity",
      "default": 5
    },
    {
      "type": "range",
      "id": "default_quantity",
      "min": 1,
      "max": 10,
      "step": 1,
      "label": "Default quantity",
      "default": 1
    },
    {
      "type": "header",
      "content": "Step 6: Coffee Type Selection"
    },
    {
      "type": "checkbox",
      "id": "enable_coffee_type_selection",
      "label": "Enable coffee type selection step",
      "default": true
    },
    {
      "type": "text",
      "id": "coffee_type_step_title",
      "label": "Coffee type step title",
      "default": "Select Coffee Type:"
    },
    {
      "type": "header",
      "content": "Step 7: Frequency Selection"
    },
    {
      "type": "checkbox",
      "id": "enable_frequency_selection",
      "label": "Enable frequency selection step",
      "default": true
    },
    {
      "type": "text",
      "id": "frequency_step_title",
      "label": "Frequency step title",
      "default": "How often?"
    },
    {
      "type": "checkbox",
      "id": "show_annual_option",
      "label": "Show annual subscription option",
      "default": true
    },
    {
      "type": "text",
      "id": "annual_option_title",
      "label": "Annual option title",
      "default": "Every Month"
    },
    {
      "type": "header",
      "content": "Step 2: Gift Options"
    },
    {
      "type": "checkbox",
      "id": "enable_gift_options",
      "label": "Enable gift options step",
      "default": false
    },
    {
      "type": "text",
      "id": "gift_step_title",
      "label": "Gift step title",
      "default": "Gift options:"
    },
    {
      "type": "header",
      "content": "Add to Cart"
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Show add to cart button",
      "default": true
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to cart button text",
      "default": "Add to Cart"
    }
  ],
  "presets": [
    {
      "name": "Subscription Selector",
      "settings": {
        "enable_product_selection": true,
        "enable_size_selection": true,
        "enable_grind_selection": true,
        "enable_quantity_selection": true,
        "enable_frequency_selection": true,
        "enable_coffee_type_selection": true,
        "enable_gift_options": false,
        "show_annual_option": true
      }
    }
  ]
}
{% endschema %}
